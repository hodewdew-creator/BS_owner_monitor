<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BS 보호자 모니터 (내부용)</title>
  <style>
    :root{--bg:#0b1220;--fg:#fff;--muted:#9ca3af;--card:#111827cc;--border:#1f2937;--blur:8px;--brand:#2b5fa3;--red:#dc2626;--gray:#6b7280;}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;padding:70px 14px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;}
    .badge{border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
    .b-전달완료{background:var(--gray);color:#fff;}
    .b-전달필요{background:var(--red);color:#fff;}
  </style>
</head>
<body>
  <div id="grid" class="grid"></div>
  <audio id="ding" src="ding.mp3" preload="auto"></audio>

  <script type="module">
    const grid=document.getElementById('grid');
    const {initializeApp}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const {getFirestore,collection,onSnapshot,query,orderBy,runTransaction,doc}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
    const app=initializeApp({apiKey:"AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4",authDomain:"bs-owner-monitor.firebaseapp.com",projectId:"bs-owner-monitor"});
    const db=getFirestore(app);

    const ding=document.getElementById('ding');
    const ring=async()=>{try{ding.currentTime=0;await ding.play();}catch{}}

    function flash(el){if(document.hidden)return;el.style.outline="3px solid #dc2626";setTimeout(()=>el.style.outline="none",5000)}

    onSnapshot(query(collection(db,"cases"),orderBy("createdAt","desc")),(snap)=>{
      grid.innerHTML="";
      snap.forEach(x=>{
        const d=x.data(),c=document.createElement('div'); c.className='card';
        c.innerHTML=`<div style="font-weight:900">${d.patientName||d.guardianName}</div>
                     <div class="badge ${d.location==='전달필요'?'b-전달필요':d.location==='전달완료'?'b-전달완료':''}">${d.location}</div>`;
        if((d.location==="상담대기중"||d.location==="면회대기중")&&!d.ackConfirmed){
          ring(); flash(c);
        }
        if(d.location==="전달필요"||d.location==="전달완료"){
          c.onclick=()=>toggleRelay(x.id,d.location);
        }
        grid.appendChild(c);
      });
    });

    async function toggleRelay(id,state){
      const ref=doc(db,"cases",id);
      const newState=(state==="전달필요")?"전달완료":"전달필요";
      await runTransaction(db,async(tx)=>{
        const snap=await tx.get(ref);const prev=snap.data();
        tx.set(ref,{location:newState,ackConfirmed:(newState==="전달완료"),updatedAt:Date.now(),version:(prev.version||0)+1},{merge:true});
      });
    }
  </script>
</body>
</html>

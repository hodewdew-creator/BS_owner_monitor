<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>ë³´í˜¸ì ìœ„ì¹˜ (í‘œì‹œÂ·ë¡œê·¸ì¸ ë³´ê°•)</title>
  <style>
    html,body{margin:0;height:100%;background:#0b1220;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;padding:6vh 4vw;gap:2vh}
    .who{font-size:6vw;font-weight:800;text-align:center;word-break:keep-all}
    .where{font-size:12vw;font-weight:900;line-height:1.1;text-align:center;word-break:keep-all;padding:1vh 2vw}
    .meta{opacity:.85;margin-top:0.5rem;font-size:4vw}
    .topbar{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0b1220b3;backdrop-filter:blur(8px)}
    .sel{font-size:16px;border-radius:8px;padding:6px 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:2vh}
    button{cursor:pointer;border:0;border-radius:14px;padding:14px 18px;font-weight:900}
    .call{background:#f97316;color:#fff;font-size:6vw}
    .clear{background:#334155;color:#fff;font-size:4vw}
    .blink{animation:blink 0.9s ease-in-out 3}
    @keyframes blink{50%{transform:scale(1.03)}}
    .statusbar{position:fixed;bottom:8px;left:8px;right:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:#1f2937;color:#fff}
    .pill.ok{background:#16a34a}.pill.err{background:#dc2626}.pill.warn{background:#f59e0b}
    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700}
    .errbox.show{display:block}
    .authbar{display:flex;align-items:center;gap:10px}
    .whoami{font-size:12px;opacity:.8}
    .disabled{opacity:.5;pointer-events:none}
  </style>
</head>
<body>
  <div class="topbar">
    <div style="font-weight:900">í‘œì‹œ í™”ë©´</div>

    <div class="authbar">
      <button id="loginBtn" class="pill">Google ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="pill" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <span id="whoami" class="whoami"></span>
      <select id="caseSelect" class="sel" title="í™˜ì ì„ íƒ"></select>
    </div>
  </div>

  <div class="wrap">
    <div id="err" class="errbox"></div>
    <div class="who" id="who">í™˜ì ì„ íƒ ëŒ€ê¸°â€¦</div>
    <div class="where" id="where"></div>
    <div class="meta" id="meta"></div>

    <div class="row">
      <button id="callBtn" class="call disabled" title="ë¡œê·¸ì¸ í›„ ì‚¬ìš©">ğŸ“£ ì½œ ìš”ì²­</button>
      <button id="clearBtn" class="clear disabled" title="ë¡œê·¸ì¸ í›„ ì‚¬ìš©">ìš”ì²­ í‘œì‹œ ì§€ìš°ê¸°</button>
    </div>
  </div>

  <div class="statusbar">
    <span id="conn" class="pill warn">ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
  </div>

  <audio id="ding" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script type="module">
    const errBox = document.getElementById('err');
    function showErr(msg){errBox.textContent=msg; errBox.classList.add('show');}
    function hideErr(){errBox.classList.remove('show');}

    window.addEventListener('error', e=> showErr('ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬: '+(e.message||'unknown')));

    try {
      // Firebase
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, doc, onSnapshot, query, orderBy, runTransaction, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

      const firebaseConfig = {
        apiKey: "AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4",
        authDomain: "bs-owner-monitor.firebaseapp.com",
        projectId: "bs-owner-monitor"
      };
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      const auth = getAuth(app);
      await setPersistence(auth, browserLocalPersistence);
      const provider = new GoogleAuthProvider();

      // UI refs
      const whoEl   = document.getElementById('who');
      const whereEl = document.getElementById('where');
      const metaEl  = document.getElementById('meta');
      const ding    = document.getElementById('ding');
      const callBtn = document.getElementById('callBtn');
      const clearBtn= document.getElementById('clearBtn');
      const caseSel = document.getElementById('caseSelect');
      const conn    = document.getElementById('conn');
      const whoami  = document.getElementById('whoami');
      const loginBtn= document.getElementById('loginBtn');
      const logoutBtn=document.getElementById('logoutBtn');

      // Auth
      function setWriteEnabled(enabled){
        [callBtn, clearBtn].forEach(b=>{
          b.classList.toggle('disabled', !enabled);
          b.title = enabled ? '' : 'ë¡œê·¸ì¸ í›„ ì‚¬ìš©';
        });
      }
      setWriteEnabled(false);

      loginBtn.onclick = async () => { try { await signInWithPopup(auth, provider); } catch(e){ showErr(e.message); } };
      logoutBtn.onclick= async () => { await signOut(auth); };

      onAuthStateChanged(auth, (user) => {
        if (user) {
          whoami.textContent = user.email;
          logoutBtn.style.display = "";
          loginBtn.style.display  = "none";
          // í—ˆìš© ì´ë©”ì¼ë§Œ ì“°ê¸° ê°€ëŠ¥ (UI ì°¨ì› ì•ˆë‚´)
          const allowed = ["bscat5653@gmail.com","moyadais@gmail.com"].includes(user.email||"");
          setWriteEnabled(allowed);
        } else {
          whoami.textContent = "";
          logoutBtn.style.display = "none";
          loginBtn.style.display  = "";
          setWriteEnabled(false);
        }
      });

      conn.textContent = "ì—°ê²°ë¨(ì´ˆê¸°)"; conn.className = "pill ok";

      let unsubCase = null;
      let currentCaseId = null;
      let lastVersion = 0;

      // í™˜ì ëª©ë¡ êµ¬ë… (ì½ê¸°ëŠ” ëˆ„êµ¬ë‚˜ ê°€ëŠ¥)
      onSnapshot(query(collection(db,"cases"), orderBy("createdAt","desc")), (snap)=>{
        hideErr();
        const selVal = caseSel.value;
        caseSel.innerHTML = "";
        snap.forEach(d=>{
          const o = document.createElement('option');
          const data = d.data();
          const pn = data.patientName||""; const gn = data.guardianName||"";
          o.value = d.id;
          o.textContent = (pn||gn) ? (pn && gn ? `${pn}(${gn})` : (pn||gn)) : d.id;
          caseSel.appendChild(o);
        });
        if (snap.size && (!selVal || ![...caseSel.options].some(o=>o.value===selVal))) {
          caseSel.selectedIndex = 0;
          selectCase(caseSel.value);
        } else if (selVal) {
          caseSel.value = selVal;
        }
      }, (e)=>{ conn.textContent="ì—°ê²° ì˜¤ë¥˜"; conn.className="pill err"; showErr("ëª©ë¡ êµ¬ë… ì‹¤íŒ¨: "+e.message); });

      caseSel.onchange = ()=> selectCase(caseSel.value);

      function selectCase(id){
        if (unsubCase) { unsubCase(); unsubCase = null; }
        currentCaseId = id;
        lastVersion = 0;
        if (!id) return;
        unsubCase = onSnapshot(doc(db,"cases",id), (snap)=>{
          hideErr();
          if (!snap.exists()) return;
          const d = snap.data();
          const pn = d.patientName || "";
          const gn = d.guardianName || "";
          const displayName = (pn||gn) ? (pn && gn ? `${pn}(${gn})` : (pn||gn)) : "ì´ë¦„ ë¯¸ì…ë ¥";
          whoEl.textContent = displayName;

          whereEl.textContent = d.location || "ì•Œ ìˆ˜ ì—†ìŒ";
          const t = d.updatedAt ? new Date(d.updatedAt).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : "";
          const req = d.callRequested ? " Â· ì½œìš”ì²­ì¤‘" : "";
          metaEl.textContent = t ? `ì—…ë°ì´íŠ¸: ${t}${req}` : (d.callRequested ? "ì½œìš”ì²­ì¤‘" : "");

          if (d.version && d.version !== lastVersion) {
            lastVersion = d.version;
            try { ding.currentTime = 0; ding.play().catch(()=>{}); } catch(e){}
            whereEl.classList.remove('blink'); void whereEl.offsetWidth; whereEl.classList.add('blink');
          }
        }, (e)=>{ conn.textContent="ì—°ê²° ì˜¤ë¥˜"; conn.className="pill err"; showErr("í™˜ì êµ¬ë… ì‹¤íŒ¨: "+e.message); });
      }

      async function updateCase(data){
        if (!currentCaseId) return showErr("í™˜ìë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        try {
          await runTransaction(db, async (tx)=>{
            const ref = doc(db,"cases", currentCaseId);
            const snap = await tx.get(ref);
            const prev = snap.exists()? snap.data(): {version:0};
            tx.set(ref, { ...data, version:(prev.version||0)+1 }, { merge:true });
          });
        } catch(e){
          showErr("ì €ì¥ ì‹¤íŒ¨: "+e.message);
        }
      }

      callBtn.onclick = ()=> updateCase({ callRequested:true, callRequestedAt: Date.now() });
      clearBtn.onclick= ()=> updateCase({ callRequested:false });

    } catch(e) {
      showErr("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: "+(e.message||e));
      const conn = document.getElementById('conn'); conn.textContent="ì´ˆê¸°í™” ì˜¤ë¥˜"; conn.className="pill err";
    }
  </script>
</body>
</html>


<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>BS ëŒ€ê¸°ì‹¤ ëª¨ë‹ˆí„°</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#ffffff; --muted:#9ca3af;
      --card:#111827cc; --border:#1f2937; --blur:8px;
      --brand:#2b5fa3;
      --s-red:#dc2626; --s-amber:#d97706; --s-sky:#0284c7; --s-green:#16a34a; --s-gray:#64748b;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .topbar{
      position:fixed; inset:0 0 auto 0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 14px; background:var(--card); border-bottom:1px solid var(--border); backdrop-filter:blur(var(--blur));
      font-size:12px;
    }
    .brandwrap{display:flex; align-items:center; gap:10px; font-weight:900}
    .logo{width:22px;height:22px;border-radius:5px;object-fit:cover}
    .brand{letter-spacing:.2px}
    .right{display:flex;align-items:center;gap:8px}
    .whoami{opacity:.8}
    .tbtn{cursor:pointer;border:0;border-radius:8px;padding:6px 8px;background:#1f2937;color:#fff;border:1px solid #374151}
    .tbtn.ok{background:var(--brand);border-color:transparent}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:800;background:#1f2937;border:1px solid #374151}
    .pill.ok{background:#16a34a}.pill.err{background:#dc2626}.pill.warn{background:#f59e0b;color:#111}

    .wrap{min-height:100%;padding:64px 14px 20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:14px; display:flex; flex-direction:column; gap:10px;
    }
    .card.call{outline:4px solid rgba(220,38,38,.6); outline-offset:-4px; animation:call 1.2s linear infinite}
    @keyframes call{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.8)}}

    .head{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .name{font-weight:900; font-size:18px; word-break:keep-all}
    .badge{
      border-radius:999px; padding:6px 10px; font-weight:900; font-size:12px; white-space:nowrap;
      border:1px solid #374151; background:#1f2937; color:#fff;
    }
    .b-ìƒë‹´ëŒ€ê¸°ì¤‘{background:var(--s-red); border-color:transparent}
    .b-ì›ë‚´ëŒ€ê¸°ì¤‘,.b-ì¹´í˜ëŒ€ê¸°ì¤‘{background:#ffd7a8; color:#111; border-color:transparent}
    .b-ì™¸ì¶œì¤‘{background:#38bdf8; color:#111; border-color:transparent}
    .b-ì¹´í˜ì½œì™„ë£Œ,.b-ì™¸ì¶œì½œì™„ë£Œ{background:#22c55e; border-color:transparent}
    .b-ê·€ê°€,.b-ìˆ˜ë‚©í›„ë¯¸ê·€ê°€{background:#e5e7eb; color:#111; border-color:transparent}

    /* â–¼ ë©”ëª¨: í…ìŠ¤íŠ¸ ê¸¸ì´ë§Œí¼ë§Œ ë°•ìŠ¤ */
    .memo{
      display:none;
      font-size:14px; line-height:1.25; font-weight:800;
      color:#111; background:#fde68a; border:1px solid #f59e0b;
      padding:5px 8px; border-radius:10px;
      display:inline-block; align-self:flex-start;
      max-width:100%; overflow-wrap:anywhere;
    }
    .memo.show{ display:inline-block; }

    .meta{font-size:12px; color:var(--muted)}

    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{cursor:pointer; border:0; border-radius:10px; padding:8px 12px; font-size:13px; font-weight:700;
      background:#1f2937; color:#fff; border:1px solid #374151;}
    .btn.ghost{background:transparent; color:#e5e7eb}

    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700;white-space:pre-wrap}
    .errbox.show{display:block}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brandwrap">
      <img class="logo" src="image-512.png" alt="BS Logo" />
      <div class="brand">BS ëŒ€ê¸°ì‹¤ ëª¨ë‹ˆí„°</div>
    </div>
    <div class="right">
      <span id="whoami" class="whoami"></span>
      <button id="loginBtn" class="tbtn ok">Google ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="tbtn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <span id="conn" class="pill warn">ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
    </div>
  </div>

  <div class="wrap">
    <div id="err" class="errbox"></div>
    <div id="grid" class="grid"></div>
  </div>

  <audio id="ding" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script type="module">
    const grid=document.getElementById('grid');
    const conn=document.getElementById('conn');
    const ding=document.getElementById('ding');
    const errBox=document.getElementById('err');
    const whoami=document.getElementById('whoami');
    const loginBtn=document.getElementById('loginBtn');
    const logoutBtn=document.getElementById('logoutBtn');

    const showErr=(m)=>{console.error(m);errBox.textContent=m;errBox.classList.add('show')};
    const hideErr=()=>errBox.classList.remove('show');

    const relTime=(ts)=>{if(!ts)return "";const s=Math.floor((Date.now()-ts)/1000);
      if(s<60)return`${s}ì´ˆ ì „`;const m=Math.floor(s/60);if(m<60)return`${m}ë¶„ ì „`;
      const h=Math.floor(m/60);if(h<24)return`${h}ì‹œê°„ ì „`;const d=Math.floor(h/24);return`${d}ì¼ ì „`};

    // ì˜¤ì „/ì˜¤í›„ h:mm í¬ë§·
    function formatKTime(ts){
      if(!ts) return "";
      const d=new Date(ts);
      let h=d.getHours(), m=d.getMinutes();
      const ampm = h<12 ? "ì˜¤ì „" : "ì˜¤í›„";
      h = h%12 || 12;
      const mm = String(m).padStart(2,"0");
      return `${ampm} ${h}:${mm}`;
    }

    // 30ì´ˆë§ˆë‹¤ ìƒëŒ€ì‹œê°„ + ë¡œì»¬ì‹œê° ê°±ì‹ 
    setInterval(()=>{document.querySelectorAll('[data-updated]').forEach(el=>{
      const ts=Number(el.dataset.updated||0);
      el.textContent = ts ? `ì—…ë°ì´íŠ¸: ${relTime(ts)} (${formatKTime(ts)})` : '';
    });},30_000);

    const badgeClass=(s)=>({
      'ìƒë‹´ëŒ€ê¸°ì¤‘':'b-ìƒë‹´ëŒ€ê¸°ì¤‘',
      'ì›ë‚´ëŒ€ê¸°ì¤‘':'b-ì›ë‚´ëŒ€ê¸°ì¤‘',
      'ì¹´í˜ëŒ€ê¸°ì¤‘':'b-ì¹´í˜ëŒ€ê¸°ì¤‘',
      'ì™¸ì¶œì¤‘':'b-ì™¸ì¶œì¤‘',
      'ì¹´í˜ì½œì™„ë£Œ':'b-ì¹´í˜ì½œì™„ë£Œ',
      'ì™¸ì¶œì½œì™„ë£Œ':'b-ì™¸ì¶œì½œì™„ë£Œ',
      'ê·€ê°€':'b-ê·€ê°€',
      'ìˆ˜ë‚©í›„ë¯¸ê·€ê°€':'b-ìˆ˜ë‚©í›„ë¯¸ê·€ê°€'
    }[s]||'');

    let auth, provider, db;

    // ding íŠ¸ë¦¬ê±° ê´€ë¦¬
    let lastCall=new Set();           // callRequested ì•Œë¦¼(ê¸°ì¡´)
    const prevState=new Map();        // id -> ì§ì „ location
    const prevHasMemo=new Map();      // id -> ì§ì „ memo ìœ ë¬´(boolean)
    let inited=false;                 // ì²« ìŠ¤ëƒ…ìƒ·ì—ëŠ” ì†Œë¦¬ ì•ˆ ìš¸ë¦¼

    try{
      const { initializeApp }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, onSnapshot, query, orderBy, runTransaction, doc }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

      const firebaseConfig={apiKey:"AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4",authDomain:"bs-owner-monitor.firebaseapp.com",projectId:"bs-owner-monitor"};
      const app=initializeApp(firebaseConfig);
      db=getFirestore(app);

      auth=getAuth(app);
      await setPersistence(auth, browserLocalPersistence).catch(e=>showErr('Persistence ì„¤ì • ì‹¤íŒ¨: '+e.message));
      provider=new GoogleAuthProvider();
      getRedirectResult(auth).catch(e=>showErr('ë¦¬ë‹¤ì´ë ‰íŠ¸ ê²°ê³¼ ì˜¤ë¥˜: '+e.message));

      async function doLogin(){
        try{ await signInWithPopup(auth, provider); }
        catch(e){
          if(e?.code==='auth/operation-not-supported-in-this-environment' || String(e?.message||'').includes('popup')){
            showErr('íŒì—… ë¡œê·¸ì¸ ë¶ˆê°€ â†’ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¡œê·¸ì¸ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
            await signInWithRedirect(auth, provider);
            return;
          }
          showErr('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+(e.code||'')+' '+e.message);
        }
      }
      loginBtn.onclick=doLogin;
      logoutBtn.onclick=async()=>{ try{ await signOut(auth); }catch(e){ showErr('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: '+e.message);} };

      onAuthStateChanged(auth,(user)=>{
        if(user){ whoami.textContent=user.email; logoutBtn.style.display=''; loginBtn.style.display='none'; }
        else{ whoami.textContent=''; logoutBtn.style.display='none'; loginBtn.style.display=''; }
      });

      conn.textContent="ì—°ê²°ë¨";conn.className="pill ok";

      onSnapshot(query(collection(db,"cases"),orderBy("createdAt","desc")),(snap)=>{
        hideErr();
        let docs=snap.docs.map(d=>({id:d.id,...d.data()}));

        // ì •ë ¬: ìƒë‹´ëŒ€ê¸°ì¤‘ â†‘, ê·€ê°€/ìˆ˜ë‚©í›„ë¯¸ê·€ê°€ â†“, ë‚˜ë¨¸ì§€ëŠ” createdAt desc
        docs.sort((a,b)=>{
          const order=(d)=> d.location==="ìƒë‹´ëŒ€ê¸°ì¤‘"?0 : (d.location==="ê·€ê°€"||d.location==="ìˆ˜ë‚©í›„ë¯¸ê·€ê°€")?2 : 1;
          const oa=order(a), ob=order(b);
          if(oa!==ob) return oa-ob;
          return (b.createdAt||0)-(a.createdAt||0);
        });

        const frag=document.createDocumentFragment();

        docs.forEach(d=>{
          // --- ì†Œë¦¬ íŠ¸ë¦¬ê±° ê³„ì‚° (ë³€ê²½ ê°ì§€) ---
          let shouldDing=false;
          const curState = d.location||"";
          const curHasMemo = !!((d.memo||"").trim());

          if(inited){
            // 1) callRequested ìƒˆë¡œ true â†’ ê¸°ì¡´ ë¡œì§ ìœ ì§€
            if(d.callRequested && !lastCall.has(d.id)) shouldDing=true;

            // 2) ìƒíƒœê°€ ìƒë‹´ëŒ€ê¸°ì¤‘ìœ¼ë¡œ "ë³€ê²½"ë˜ì—ˆì„ ë•Œ
            const prevS = prevState.get(d.id);
            if(curState==="ìƒë‹´ëŒ€ê¸°ì¤‘" && prevS!=="ìƒë‹´ëŒ€ê¸°ì¤‘") shouldDing=true;

            // 3) ë©”ëª¨ê°€ "ì¶”ê°€"ë˜ì—ˆì„ ë•Œ (ë¹ˆâ†’ë‚´ìš©)
            const prevM = prevHasMemo.get(d.id);
            if(curHasMemo && !prevM) shouldDing=true;
          }

          // callRequested ì§‘í•© ê´€ë¦¬(ê¸°ì¡´)
          if(d.callRequested) lastCall.add(d.id); else lastCall.delete(d.id);

          if(shouldDing){
            try{ ding.currentTime=0; ding.play().catch(()=>{});}catch(e){}
          }

          // ìƒíƒœ ê¸°ë¡ ê°±ì‹ 
          prevState.set(d.id, curState);
          prevHasMemo.set(d.id, curHasMemo);

          // --- ì¹´ë“œ ë Œë” ---
          const card=document.createElement('div');card.className='card';
          if(d.callRequested) card.classList.add('call');

          const head=document.createElement('div');head.className='head';
          const name=document.createElement('div');name.className='name';
          name.textContent=(d.patientName||d.guardianName)
            ?(d.patientName&&d.guardianName?`${d.patientName}(${d.guardianName})`:(d.patientName||d.guardianName))
            :d.id;
          const badge=document.createElement('span');badge.className='badge '+badgeClass(curState);
          badge.textContent=curState||'ìƒíƒœì—†ìŒ';
          head.appendChild(name);head.appendChild(badge);
          card.appendChild(head);

          const memoTxt=(d.memo||"").trim();
          if(memoTxt){
            const memo=document.createElement('div');memo.className='memo show';
            memo.textContent=memoTxt.length>140?memoTxt.slice(0,137)+'â€¦':memoTxt;
            card.appendChild(memo);
          }

          const meta=document.createElement('div');meta.className='meta';
          meta.dataset.updated=d.updatedAt||0;
          meta.textContent=d.updatedAt?`ì—…ë°ì´íŠ¸: ${relTime(d.updatedAt)} (${formatKTime(d.updatedAt)})`:'';
          card.appendChild(meta);

          const actions=document.createElement('div');actions.className='actions';
          const callBtn=document.createElement('button');callBtn.className='btn';callBtn.textContent='ğŸ“£ ì½œìš”ì²­í•˜ê¸°';
          const cancelBtn=document.createElement('button');cancelBtn.className='btn ghost';cancelBtn.textContent='ì½œìš”ì²­ì·¨ì†Œ';
          callBtn.onclick=()=> requireLoginThen(()=>updateCase(d.id,{callRequested:true,callRequestedAt:Date.now()}));
          cancelBtn.onclick=()=> requireLoginThen(()=>updateCase(d.id,{callRequested:false}));
          actions.appendChild(callBtn);actions.appendChild(cancelBtn);
          card.appendChild(actions);

          frag.appendChild(card);
        });

        grid.innerHTML='';grid.appendChild(frag);
        // ì²« ìŠ¤ëƒ…ìƒ· ì²˜ë¦¬ ì™„ë£Œ í›„ë¶€í„° ë³€ê²½ ê°ì§€ í™œì„±í™”
        if(!inited) inited=true;
      },(e)=>{conn.textContent='ì—°ê²° ì˜¤ë¥˜';conn.className='pill err';showErr('ë¦¬ìŠ¤íŠ¸ êµ¬ë… ì‹¤íŒ¨: '+e.message);});

      function requireLoginThen(fn){
        if(auth.currentUser){ fn(); return; }
        showErr('ì´ ì‘ì—…ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ ì°½ì„ ì—´ê²Œìš”.');
        doLogin();
      }

      async function updateCase(id,data){
        try{
          await runTransaction(db,async(tx)=>{
            const ref=doc(db,"cases",id);
            const snap=await tx.get(ref);
            const prev=snap.exists()?snap.data():{version:0};
            tx.set(ref,{...data,updatedAt:Date.now(),version:(prev.version||0)+1},{merge:true});
          });
        }catch(e){showErr("ì €ì¥ ì‹¤íŒ¨: "+(e.code||'')+' '+e.message);}
      }

    }catch(e){
      conn.textContent='ì´ˆê¸°í™” ì˜¤ë¥˜';conn.className='pill err';
      showErr('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: '+(e.message||e));
    }
  </script>
</body>
</html>

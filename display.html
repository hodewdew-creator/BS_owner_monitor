<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>보호자 위치 (표시·MVP)</title>
  <style>
    html,body{margin:0;height:100%;background:#0b1220;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;padding:6vh 4vw;gap:2vh}
    .who{font-size:6vw;font-weight:800;text-align:center;word-break:keep-all}
    .where{font-size:12vw;font-weight:900;line-height:1.1;text-align:center;word-break:keep-all;padding:1vh 2vw}
    .meta{opacity:.85;margin-top:0.5rem;font-size:4vw}
    .topbar{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0b1220b3;backdrop-filter:blur(8px)}
    .sel{font-size:16px;border-radius:8px;padding:6px 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:2vh}
    button{cursor:pointer;border:0;border-radius:14px;padding:14px 18px;font-weight:900}
    .call{background:#f97316;color:#fff;font-size:6vw}
    .clear{background:#334155;color:#fff;font-size:4vw}
    .blink{animation:blink 0.9s ease-in-out 3}
    @keyframes blink{50%{transform:scale(1.03)}}
    
    .statusbar{position:fixed;bottom:8px;left:8px;right:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:#1f2937;color:#fff}
    .pill.ok{background:#16a34a}.pill.err{background:#dc2626}.pill.warn{background:#f59e0b}
    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700}
    .errbox.show{display:block}

      .statusbtn{background:#166534;color:#fff} /* 톤다운 초록 + 흰글씨 */
  </style>
</head>
<body>
  <div class="topbar">
    <div style="font-weight:900">표시 화면</div>
    <select id="caseSelect" class="sel" title="환자 선택"></select>
  </div>

  <div class="wrap">
    <div id="err" class="errbox"></div>
    <div class="who" id="who">환자 선택 대기…</div>
    <div class="where" id="where"></div>
    <div class="meta" id="meta"></div>

    <div class="row">
      <button id="callBtn" class="call">📣 콜 요청</button>
      <button id="clearBtn" class="clear">요청 표시 지우기</button>
      <button id="cafeDoneBtn" class="statusbtn">카페콜완료</button>
      <button id="awayDoneBtn" class="statusbtn">외출콜완료</button>
    </div>
  </div>

  <div class="statusbar">
    <span id="conn" class="pill warn">연결 확인 중…</span>
    <button id="selftest" class="pill">연결 테스트</button>
  </div>

  <audio id="ding" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script type="module">
    const errBox = document.getElementById('err');
    function showErr(msg){errBox.textContent=msg; errBox.classList.add('show');}
    function hideErr(){errBox.classList.remove('show');}

    window.addEventListener('error', e=> showErr('스크립트 에러: '+(e.message||'unknown')));

    let app, db;
    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, doc, onSnapshot, query, orderBy, runTransaction, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      const firebaseConfig = { apiKey:"AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4", authDomain:"bs-owner-monitor.firebaseapp.com", projectId:"bs-owner-monitor" };
      app = initializeApp(firebaseConfig);
      db  = getFirestore(app);

      const whoEl   = document.getElementById('who');
      const whereEl = document.getElementById('where');
      const metaEl  = document.getElementById('meta');
      const ding    = document.getElementById('ding');
      const callBtn = document.getElementById('callBtn');
      const clearBtn= document.getElementById('clearBtn');
      const cafeDoneBtn = document.getElementById('cafeDoneBtn');
      const awayDoneBtn = document.getElementById('awayDoneBtn');
      const caseSel = document.getElementById('caseSelect');
      const conn    = document.getElementById('conn');
      const selftest= document.getElementById('selftest');

      conn.textContent = "연결됨(초기)"; conn.className = "pill ok";

      let unsubCase = null;
      let currentCaseId = null;
      let lastVersion = 0;

      // 환자 목록
      onSnapshot(query(collection(db,"cases"), orderBy("createdAt","desc")), (snap)=>{
        hideErr();
        const selVal = caseSel.value;
        caseSel.innerHTML = "";
        snap.forEach(d=>{
          const o = document.createElement('option');
          const data = d.data();
          const pn = data.patientName||""; const gn = data.guardianName||"";
          o.value = d.id;
          o.textContent = (pn&&gn) ? `${pn}(${gn})` : (pn||gn||d.id);
          caseSel.appendChild(o);
        });
        if (snap.size && (!selVal || ![...caseSel.options].some(o=>o.value===selVal))) {
          caseSel.selectedIndex = 0;
          selectCase(caseSel.value);
        } else if (selVal) {
          caseSel.value = selVal;
        }
      }, (e)=>{ conn.textContent="연결 오류"; conn.className="pill err"; showErr("목록 구독 실패: "+e.message); });

      caseSel.onchange = ()=> selectCase(caseSel.value);

      function selectCase(id){
        if (unsubCase) { unsubCase(); unsubCase = null; }
        currentCaseId = id;
        lastVersion = 0;
        if (!id) return;
        unsubCase = onSnapshot(doc(db,"cases",id), (snap)=>{
          hideErr();
          if (!snap.exists()) return;
          const d = snap.data();
          const pn = d.patientName || "";
          const gn = d.guardianName || "";
          const displayName = (pn&&gn) ? `${pn}(${gn})` : (pn||gn||"이름 미입력");
          whoEl.textContent = displayName;

          whereEl.textContent = d.location || "알 수 없음";
          const t = d.updatedAt ? new Date(d.updatedAt).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : "";
          const req = d.callRequested ? " · 콜요청중" : "";
          metaEl.textContent = t ? `업데이트: ${t}${req}` : (d.callRequested ? "콜요청중" : "");

          if (d.version && d.version !== lastVersion) {
            lastVersion = d.version;
            try { ding.currentTime = 0; ding.play().catch(()=>{}); } catch(e){}
            whereEl.classList.remove('blink'); void whereEl.offsetWidth; whereEl.classList.add('blink');
          }
        }, (e)=>{ conn.textContent="연결 오류"; conn.className="pill err"; showErr("환자 구독 실패: "+e.message); });
      }

      async function updateCase(data){
        if (!currentCaseId) return showErr("환자를 먼저 선택하세요.");
        const ref = doc(db,"cases", currentCaseId);
        try {
          await runTransaction(db, async (tx)=>{
            const snap = await tx.get(ref);
            const prev = snap.exists()? snap.data(): {version:0};
            tx.set(ref, { ...data, version:(prev.version||0)+1 }, { merge:true });
          });
        } catch(e){
          showErr("저장 실패: "+e.message);
        }
      }

      callBtn.onclick = ()=> updateCase({ callRequested:true, callRequestedAt: Date.now() });
      clearBtn.onclick= ()=> updateCase({ callRequested:false });
      // 보호자 상태: 카페콜완료 / 외출콜완료
      cafeDoneBtn.onclick = ()=> updateCase({ location: '카페콜완료', updatedAt: Date.now() });
      awayDoneBtn.onclick = ()=> updateCase({ location: '외출콜완료', updatedAt: Date.now() });

      selftest.onclick = async ()=>{
        try {
          const ref = doc(db,"healthcheck","display");
          await setDoc(ref, { ping: Date.now() }, { merge:true });
          conn.textContent="연결 정상"; conn.className="pill ok";
          hideErr();
        } catch(e){ conn.textContent="연결 오류"; conn.className="pill err"; showErr("연결 테스트 실패: "+e.message); }
      };

    } catch(e) {
      showErr("Firebase 초기화 실패: "+(e.message||e));
      const conn = document.getElementById('conn'); conn.textContent="초기화 오류"; conn.className="pill err";
    }
  </script>
</body>
</html>

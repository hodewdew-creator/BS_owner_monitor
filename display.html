<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>보호자 위치 (처치실·전체카드 보기)</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#ffffff; --muted:#9ca3af; --card:#111827cc; --blur:8px;
      --blue:#2563eb; --yellow:#f59e0b; --green:#16a34a; --purple:#8b5cf6; --gray:#6b7280; --red:#dc2626;
      --border:#1f2937; --panel:#0f172a;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;background:var(--card);backdrop-filter:blur(var(--blur));z-index:10;border-bottom:1px solid var(--border)}
    .brand{font-weight:900}
    .authbar{display:flex;gap:8px;align-items:center}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:#1f2937;color:#fff;border:1px solid #374151}
    .pill.ok{background:var(--green)} .pill.err{background:var(--red)} .pill.warn{background:var(--yellow);color:#111}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:800;background:#1f2937;color:#fff;border:1px solid #374151}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 10px;font-weight:700}
    .btn.disabled{opacity:.5;pointer-events:none}

    .wrap{min-height:100%;padding:64px 16px 20px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:12px 0}
    .search{display:flex;gap:8px;align-items:center}
    .field{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:#fff}

    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:14px}
    .pcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .pcard.calling{outline:4px solid rgba(220,38,38,.6);outline-offset:-4px;animation:frame 1.2s linear infinite}
    @keyframes frame{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.7)}}
    .head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .name{font-weight:900;font-size:18px;word-break:keep-all}
    .badge{border-radius:999px;padding:6px 10px;font-weight:900}
    .loc{font-size:28px;font-weight:900;line-height:1.1;margin-top:2px;word-break:keep-all}
    .meta{font-size:12px;opacity:.85}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .tiny{font-size:11px;opacity:.8}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">처치실 화면 · 전체 카드</div>
    <div class="authbar">
      <button id="fsBtn" class="pill">⛶ 풀스크린</button>
      <button id="loginBtn" class="pill">Google 로그인</button>
      <button id="logoutBtn" class="pill" style="display:none">로그아웃</button>
      <span id="whoami" class="tiny"></span>
      <span id="conn" class="pill warn">연결 확인 중…</span>
    </div>
  </div>

  <div class="wrap">
    <div class="toolbar">
      <div class="search">
        <input id="q" class="field" placeholder="이름 검색 (고양이/보호자)" />
        <select id="filter" class="field">
          <option value="">전체 상태</option>
          <option>원내대기중</option>
          <option>카페대기중</option>
          <option>카페콜완료</option>
          <option>외출</option>
          <option>귀가</option>
        </select>
      </div>
      <div class="tiny">* 버튼 작동은 로그인 후</div>
    </div>

    <div id="err" class="errbox"></div>
    <div id="grid" class="grid"></div>
  </div>

  <audio id="ding" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script type="module">
    const errBox = document.getElementById('err');
    const grid = document.getElementById('grid');
    const q = document.getElementById('q');
    const filter = document.getElementById('filter');
    function showErr(msg){errBox.textContent=msg; errBox.classList.add('show');}
    function hideErr(){errBox.classList.remove('show');}

    const fsBtn = document.getElementById('fsBtn');
    fsBtn.onclick = () => {
      const el = document.documentElement;
      if (!document.fullscreenElement) el.requestFullscreen().catch(()=>{});
      else document.exitFullscreen();
    };

    function relTime(ts){
      if(!ts) return "";
      const s = Math.floor((Date.now()-ts)/1000);
      if (s < 60) return `${s}초 전`;
      const m = Math.floor(s/60); if (m < 60) return `${m}분 전`;
      const h = Math.floor(m/60); if (h < 24) return `${h}시간 전`;
      const d = Math.floor(h/24); return `${d}일 전`;
    }
    function locColor(loc){
      return {
        "원내대기중":"var(--blue)",
        "카페대기중":"var(--yellow)",
        "카페콜완료":"var(--green)",
        "외출":"var(--purple)",
        "귀가":"var(--gray)"
      }[loc] || "#111827";
    }

    try{
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, onSnapshot, query, orderBy, runTransaction, doc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

      const firebaseConfig = {
        apiKey: "AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4",
        authDomain: "bs-owner-monitor.firebaseapp.com",
        projectId: "bs-owner-monitor"
      };
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      const auth = getAuth(app);
      await setPersistence(auth, browserLocalPersistence);
      const provider = new GoogleAuthProvider();

      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn= document.getElementById('logoutBtn');
      const whoami   = document.getElementById('whoami');
      const conn     = document.getElementById('conn');
      const ding     = document.getElementById('ding');

      let canWrite = false;
      function updateWriteAbility(user){
        if (user && ["bscat5653@gmail.com","moyadais@gmail.com"].includes(user.email||"")) {
          canWrite = true;
          whoami.textContent = user.email;
          loginBtn.style.display = 'none';
          logoutBtn.style.display = '';
        } else {
          canWrite = false;
          whoami.textContent = user? user.email : '';
          loginBtn.style.display = '';
          logoutBtn.style.display = 'none';
        }
        // 버튼 활성/비활성은 각 카드 렌더 시 반영
      }

      loginBtn.onclick = async ()=>{ try{ await signInWithPopup(auth, provider);}catch(e){ showErr(e.message);} };
      logoutBtn.onclick= async ()=>{ await signOut(auth); };
      onAuthStateChanged(auth, user=> updateWriteAbility(user));

      conn.textContent = "연결됨"; conn.className = "pill ok";

      let cache = [];
      onSnapshot(query(collection(db,"cases"), orderBy("createdAt","desc")), (snap)=>{
        hideErr();
        cache = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        render();
      }, (e)=>{ conn.textContent="연결 오류"; conn.className="pill err"; showErr("목록 구독 실패: "+e.message); });

      q.oninput = render; filter.onchange = render;

      function render(){
        const term = (q.value||"").trim().toLowerCase();
        const f = (filter.value||"");
        const list = cache.filter(d=>{
          const name = `${d.patientName||''} ${d.guardianName||''}`.toLowerCase();
          const okName = term? name.includes(term) : true;
          const okLoc  = f? d.location===f : true;
          return okName && okLoc;
        });

        grid.innerHTML = '';
        list.forEach(d=> grid.appendChild(cardEl(d)) );
      }

      function cardEl(d){
        const el = document.createElement('div'); el.className = 'pcard';
        if (d.callRequested) el.classList.add('calling');

        const header = document.createElement('div'); header.className='head';
        const name = document.createElement('div'); name.className='name';
        const display = (d.patientName||d.guardianName) ? (d.patientName && d.guardianName ? `${d.patientName}(${d.guardianName})` : (d.patientName||d.guardianName)) : d.id;
        name.textContent = display;
        const badge = document.createElement('span'); badge.className='badge';
        badge.style.background = locColor(d.location||'');
        badge.style.color = (d.location==="카페대기중")? '#111' : '#fff';
        badge.textContent = d.location || '상태없음';
        header.appendChild(name); header.appendChild(badge);

        const loc = document.createElement('div'); loc.className='loc'; loc.textContent = d.location || '';
        const meta = document.createElement('div'); meta.className='meta';
        meta.textContent = `업데이트: ${relTime(d.updatedAt||0)}${d.callRequested? ' · 콜요청중':''}`;

        const actions = document.createElement('div'); actions.className='actions';
        const callBtn = document.createElement('button'); callBtn.className='btn'; callBtn.textContent='📣 콜 요청';
        const clearBtn= document.createElement('button'); clearBtn.className='btn ghost'; clearBtn.textContent='요청 표시 지우기';

        if (!canWrite){ callBtn.classList.add('disabled'); clearBtn.classList.add('disabled'); }

        callBtn.onclick = ()=> updateCase(d.id,{ callRequested:true, callRequestedAt: Date.now() });
        clearBtn.onclick= ()=> updateCase(d.id,{ callRequested:false });

        actions.appendChild(callBtn); actions.appendChild(clearBtn);

        el.appendChild(header);
        el.appendChild(loc);
        el.appendChild(meta);
        el.appendChild(actions);

        return el;
      }

      async function updateCase(id, data){
        if (!canWrite) return showErr('로그인 후 사용하세요');
        try{
          await runTransaction(db, async (tx)=>{
            const ref = doc(db,'cases', id);
            const snap = await tx.get(ref);
            const prev = snap.exists()? snap.data(): {version:0};
            tx.set(ref, { ...data, updatedAt: Date.now(), version:(prev.version||0)+1 }, { merge:true });
          });
          hideErr();
        }catch(e){ showErr('저장 실패: '+e.message); }
      }

    }catch(e){
      showErr('Firebase 초기화 실패: '+(e.message||e));
      const conn = document.getElementById('conn'); if (conn){ conn.textContent='초기화 오류'; conn.className='pill err'; }
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>보호자 위치 (리셉션)</title>
  <style>
    body{margin:0;padding:16px;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#fafafa}
    h1{margin:0 0 12px}
    .row{display:flex;gap:8px;margin:8px 0;align-items:flex-end;flex-wrap:wrap}
    button{cursor:pointer;border:0;border-radius:10px;padding:12px 14px;font-weight:700}

    /* 상태 버튼 색상 (디스플레이 매핑과 동일) */
    .statebtn-상담대기중{background:#dc2626;color:#fff}
    .statebtn-원내대기중{background:#fed7aa;color:#000}
    .statebtn-카페대기중{background:#fed7aa;color:#000}
    .statebtn-외출중{background:#38bdf8;color:#000}
    .statebtn-카페콜완료{background:#22c55e;color:#fff}
    .statebtn-외출콜완료{background:#22c55e;color:#fff}
    .statebtn-귀가{background:#9ca3af;color:#000}
    .statebtn-수납후미귀가{background:#9ca3af;color:#000}
    .statebtn-삭제{background:#000;color:#fff}

    .list{margin-top:16px}
    .line{display:grid;grid-template-columns:1.4fr .8fr .8fr;gap:8px;align-items:center;
          background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;margin-bottom:6px}
    .name{font-weight:800;text-align:left}
    .state{font-weight:900;text-align:center}
    .updated{font-size:12px;opacity:.7;text-align:right}
    .line.calling{outline:3px solid rgba(220,38,38,.6); animation:callblink 1.1s linear infinite}
    @keyframes callblink{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.8)}}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700}
    .errbox.show{display:block}
  </style>
</head>
<body>
  <h1>보호자 위치 업데이트 (리셉션)</h1>

  <div id="err" class="errbox"></div>

  <!-- 공용 상태 버튼 -->
  <div class="toolbar" id="globalStates"></div>

  <!-- 환자 리스트 -->
  <div class="list" id="caseList"></div>

  <script type="module">
    const errBox = document.getElementById('err');
    function showErr(msg){errBox.textContent=msg; errBox.classList.add('show');}
    function hideErr(){errBox.classList.remove('show');}

    function relTime(ts){
      if(!ts) return "";
      const s = Math.floor((Date.now()-ts)/1000);
      if (s < 60) return `${s}초 전`;
      const m = Math.floor(s/60); if (m < 60) return `${m}분 전`;
      const h = Math.floor(m/60); if (h < 24) return `${h}시간 전`;
      const d = Math.floor(h/24); return `${d}일 전`;
    }

    try{
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, onSnapshot, query, orderBy, runTransaction, doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      const firebaseConfig = { apiKey:"AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4", authDomain:"bs-owner-monitor.firebaseapp.com", projectId:"bs-owner-monitor" };
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      const caseList = document.getElementById('caseList');
      const globalStates = document.getElementById('globalStates');

      const STATES = ["상담대기중","원내대기중","카페대기중","외출중","카페콜완료","외출콜완료","귀가","수납후미귀가","삭제"];
      let selectedId = null;

      STATES.forEach(s=>{
        const b = document.createElement('button');
        b.textContent = s;
        b.className = `statebtn-${s}`;
        b.onclick = ()=> applyGlobalState(s);
        globalStates.appendChild(b);
      });

      onSnapshot(query(collection(db,'cases'), orderBy('createdAt','desc')), (snap)=>{
        caseList.innerHTML='';
        snap.forEach(docu=>{
          const d = docu.data();
          const el = document.createElement('div'); el.className='line'; el.dataset.id = docu.id;
          if (d.callRequested) el.classList.add('calling');
          el.onclick = ()=>{ selectedId = docu.id; };

          const name = document.createElement('div'); name.className='name'; name.textContent = (d.patientName||d.guardianName)||docu.id;
          const state= document.createElement('div'); state.className='state'; state.textContent = d.location||'';
          const upd  = document.createElement('div'); upd.className='updated'; upd.textContent = relTime(d.updatedAt);

          el.appendChild(name); el.appendChild(state); el.appendChild(upd);
          caseList.appendChild(el);
        });
      });

      async function applyGlobalState(state){
        if (!selectedId){ showErr('환자를 먼저 선택하세요'); return; }
        const ref = doc(db,'cases',selectedId);
        try{
          if(state==="삭제"){
            await deleteDoc(ref);
            selectedId=null;
            return;
          }
          await runTransaction(db, async (tx)=>{
            const snap = await tx.get(ref);
            const prev = snap.exists()? snap.data(): {version:0};
            tx.set(ref, { location:state, updatedAt:Date.now(), version:(prev.version||0)+1, callRequested:false }, { merge:true });
          });
          hideErr();
        }catch(e){ showErr('저장 실패: '+e.message); }
      }

    }catch(e){
      showErr('Firebase 초기화 실패: '+(e.message||e));
    }
  </script>
</body>
</html>

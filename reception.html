<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>보호자 위치 (처치실·전체 카드)</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#ffffff; --muted:#9ca3af; --card:#111827cc; --blur:8px;
      --border:#1f2937;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;background:var(--card);backdrop-filter:blur(var(--blur));z-index:10;border-bottom:1px solid var(--border)}
    .brand{font-weight:900}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:#1f2937;color:#fff;border:1px solid #374151}
    .pill.ok{background:#16a34a} .pill.err{background:#dc2626} .pill.warn{background:#f59e0b;color:#111}

    .wrap{min-height:100%;padding:64px 16px 20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
    .pcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .pcard.calling{outline:4px solid rgba(220,38,38,.6);outline-offset:-4px;animation:frame 1.2s linear infinite}
    @keyframes frame{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.7)}}
    .head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .name{font-weight:900;font-size:18px;word-break:keep-all}
    .badge{border-radius:999px;padding:6px 10px;font-weight:900}
    .loc{font-size:28px;font-weight:900;line-height:1.1;margin-top:2px;word-break:keep-all}
    .meta{font-size:12px;opacity:.85}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:800;background:#1f2937;color:#fff;border:1px solid #374151}
    .btn.ghost{background:transparent}

    /* 상태 배지 색상 (유지) */
    .bg-상담대기중{background:#dc2626;color:#fff}
    .bg-원내대기중{background:#f97316;color:#000}
    .bg-카페대기중{background:#f97316;color:#000}
    .bg-외출중{background:#38bdf8;color:#000}
    .bg-카페콜완료{background:#166534;color:#fff}
    .bg-외출콜완료{background:#166534;color:#fff}
    .bg-귀가{background:#9ca3af;color:#000}
    .bg-수납후미귀가{background:#9ca3af;color:#000}

    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700}
    .errbox.show{display:block}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">처치실 화면 · 전체 카드</div>
    <div>
      <span id="conn" class="pill warn">연결 확인 중…</span>
    </div>
  </div>

  <div class="wrap">
    <div id="err" class="errbox"></div>
    <div id="grid" class="grid"></div>
  </div>

  <audio id="ding" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script type="module">
    const errBox = document.getElementById('err');
    function showErr(msg){errBox.textContent=msg; errBox.classList.add('show');}
    function hideErr(){errBox.classList.remove('show');}

    const grid = document.getElementById('grid');
    const conn = document.getElementById('conn');
    const ding = document.getElementById('ding');

    function relTime(ts){
      if(!ts) return "";
      const s = Math.floor((Date.now()-ts)/1000);
      if (s < 60) return `${s}초 전`;
      const m = Math.floor(s/60); if (m < 60) return `${m}분 전`;
      const h = Math.floor(m/60); if (h < 24) return `${h}시간 전`;
      const d = Math.floor(h/24); return `${d}일 전`;
    }

    function stateClass(loc){
      const map = {
        '상담대기중':'bg-상담대기중',
        '원내대기중':'bg-원내대기중',
        '카페대기중':'bg-카페대기중',
        '외출중':'bg-외출중',
        '카페콜완료':'bg-카페콜완료',
        '외출콜완료':'bg-외출콜완료',
        '귀가':'bg-귀가',
        '수납후미귀가':'bg-수납후미귀가'
      };
      return map[loc]||'';
    }

    try{
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, onSnapshot, query, orderBy, runTransaction, doc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      const firebaseConfig = { apiKey:"AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4", authDomain:"bs-owner-monitor.firebaseapp.com", projectId:"bs-owner-monitor" };
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      conn.textContent = "연결됨"; conn.className = "pill ok";

      let cache = [];
      onSnapshot(query(collection(db,'cases'), orderBy('createdAt','desc')), (snap)=>{
        hideErr();
        cache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        render();
      }, (e)=>{ conn.textContent='연결 오류'; conn.className='pill err'; showErr('목록 구독 실패: '+e.message); });

      function displayName(d){
        return (d.patientName||d.guardianName)
          ? (d.patientName && d.guardianName ? `${d.patientName}(${d.guardianName})` : (d.patientName||d.guardianName))
          : d.id;
      }

      function displayLocation(d){
        return d.location || '';
      }

      function cardEl(d){
        const el = document.createElement('div'); el.className = 'pcard';
        if (d.callRequested) el.classList.add('calling');

        const header = document.createElement('div'); header.className='head';
        const name = document.createElement('div'); name.className='name'; name.textContent = displayName(d);
        const badge = document.createElement('span'); badge.className='badge '+stateClass(d.location||''); badge.textContent = displayLocation(d) || '상태없음';
        header.appendChild(name); header.appendChild(badge);

        const loc = document.createElement('div'); loc.className='loc'; loc.textContent = displayLocation(d);
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `업데이트: ${relTime(d.updatedAt||0)}${d.callRequested? ' · 콜요청중':''}`;

        const actions = document.createElement('div'); actions.className='actions';
        const callBtn = document.createElement('button'); callBtn.className='btn'; callBtn.textContent='📣 콜 요청';
        const clearBtn= document.createElement('button'); clearBtn.className='btn ghost'; clearBtn.textContent='요청 지우기';
        
        callBtn.onclick = ()=> updateCase(d.id,{ callRequested:true, callRequestedAt: Date.now() });
        clearBtn.onclick= ()=> updateCase(d.id,{ callRequested:false });

        actions.appendChild(callBtn); actions.appendChild(clearBtn);

        el.appendChild(header);
        el.appendChild(loc);
        el.appendChild(meta);
        el.appendChild(actions);
        return el;
      }

      function render(){
        grid.innerHTML='';
        cache.forEach(d=> grid.appendChild(cardEl(d)) );
      }

      async function updateCase(id, data){
        try{
          await runTransaction(db, async (tx)=>{
            const ref = doc(db,'cases', id);
            const snap = await tx.get(ref);
            const prev = snap.exists()? snap.data(): {version:0};
            tx.set(ref, { ...data, version:(prev.version||0)+1 }, { merge:true });
          });
        }catch(e){ showErr('저장 실패: '+e.message); }
      }

    }catch(e){
      showErr('Firebase 초기화 실패: '+(e.message||e));
      if (conn){ conn.textContent='초기화 오류'; conn.className='pill err'; }
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ë³´í˜¸ì ìœ„ì¹˜ (ë¦¬ì…‰ì…˜Â·ê°œì„ )</title>
  <style>
    body{margin:0;padding:16px;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#fafafa}
    h1{margin:0 0 12px}
    .auth{display:flex;gap:8px;margin:8px 0 16px;align-items:center}
    input[type=text]{flex:1;padding:12px;border:1px solid #cbd5e1;border-radius:10px;font-size:16px;background:#fff}
    .row{display:flex;gap:8px;margin:8px 0;align-items:flex-end;flex-wrap:wrap}
    button{cursor:pointer;border:0;border-radius:10px;padding:12px 14px;font-weight:700;background:#e2e8f0}
    .ok{background:#2563eb;color:#fff}
    .destructive{background:#ef4444;color:#fff}
    .mutedbtn{background:#111827;color:#fff}
    .small{font-size:12px;opacity:.75;margin-top:8px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-bottom:12px}
    label{font-size:12px;color:#475569;margin-left:2px}

    /* ë¦¬ìŠ¤íŠ¸ = í•œ í–‰ì”© */
    .list{display:grid;grid-template-columns:1fr;gap:6px;margin-top:8px}
    .line{display:grid;grid-template-columns:1.4fr .8fr .6fr;gap:8px;align-items:center;
          background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    .name{font-weight:800;text-align:left}
    .state{font-weight:900;text-align:center}
    .updated{font-size:12px;opacity:.7;text-align:right}
    .line.select{outline:3px solid #2563eb; outline-offset:0}
    .line.calling{outline:3px solid rgba(220,38,38,.6); animation:callblink 1.1s linear infinite}
    @keyframes callblink{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.8)}}

    /* ê³µìš© ìƒíƒœ ë²„íŠ¼ ë°” */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .muted{opacity:.6}
    .statusbar{position:fixed;bottom:8px;left:8px;right:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:#1f2937;color:#fff}
    .pill.ok{background:#16a34a}.pill.err{background:#dc2626}.pill.warn{background:#f59e0b}
    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700}
    .errbox.show{display:block}
    .whoami{font-size:12px;opacity:.7}

    .alert{display:none;margin:10px 0;padding:14px 16px;border-radius:12px;border:2px solid #ef4444;background:#fef2f2;color:#991b1b;font-weight:900}
    .alert.show{display:block;animation:pop .5s}
    @keyframes pop{from{transform:scale(.98)}to{transform:scale(1)}}
  </style>
</head>
<body>
  <h1>ë³´í˜¸ì ìœ„ì¹˜ ì—…ë°ì´íŠ¸</h1>

  <div id="err" class="errbox"></div>

  <!-- ë¡œê·¸ì¸ -->
  <div id="authBox" class="auth">
    <button id="loginBtn" class="ok">Googleë¡œ ë¡œê·¸ì¸</button>
    <button id="logoutBtn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
    <span id="whoami" class="whoami"></span>
  </div>

  <!-- ì½œìš”ì²­ ì•Œë¦¼ -->
  <div id="alertBox" class="alert">ğŸ“£ ì²˜ì¹˜ì‹¤ì—ì„œ <span id="alertWho"></span> ì½œ ìš”ì²­!
    <button id="ack" class="ok" style="margin-left:8px">ì²˜ë¦¬ì™„ë£Œ</button>
  </div>

  <div id="panel" style="display:none">
    <!-- í™˜ì ì…ë ¥ + ì¶”ê°€ -->
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label>ê³ ì–‘ì´ ì´ë¦„</label>
          <input id="patientName" type="text" placeholder="ì˜ˆ: ê³µì‹¬ì´" />
        </div>
        <div style="flex:1">
          <label>ë³´í˜¸ì ì´ë¦„</label>
          <input id="guardianName" type="text" placeholder="ì˜ˆ: ê¹€OO" />
        </div>
        <button id="addCase" class="ok">í™˜ì ì¶”ê°€</button>
      </div>

      <!-- ê³µìš© ìƒíƒœ/ê´€ë¦¬ ë²„íŠ¼ (ì„ íƒëœ í™˜ìì— ì ìš©) -->
      <div style="margin-top:10px">
        <div class="small muted">ì„ íƒ í™˜ìì— ì ìš©ë©ë‹ˆë‹¤.</div>
        <div class="toolbar" id="globalStates">
          <!-- JSì—ì„œ ë²„íŠ¼ ìƒì„± -->
        </div>
        <div class="toolbar" style="margin-top:8px">
          <button id="renameBtn" class="mutedbtn">ì´ë¦„ ë³€ê²½</button>
          <button id="deleteBtn" class="destructive">ì‚­ì œ</button>
        </div>
      </div>
    </div>

    <!-- í™˜ì ë¦¬ìŠ¤íŠ¸ (í•œ í–‰ì”©, ê°œë³„ ë²„íŠ¼ ì—†ìŒ) -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>í™˜ì ë¦¬ìŠ¤íŠ¸</strong>
        <span class="small muted">í–‰ì„ í´ë¦­í•˜ë©´ ì„ íƒë©ë‹ˆë‹¤.</span>
      </div>
      <div class="list">
        <div class="line muted" style="background:#f8fafc">
          <div class="name">ì´ë¦„</div>
          <div class="state">ìƒíƒœ</div>
          <div class="updated">ì—…ë°ì´íŠ¸</div>
        </div>
        <div id="caseList" class="list"></div>
      </div>
    </div>
  </div>

  <div class="statusbar">
    <span id="conn" class="pill warn">ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
    <button id="selftest" class="pill">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
  </div>

  <audio id="bell" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script type="module">
    const errBox = document.getElementById('err');
    function showErr(msg){errBox.textContent=msg; errBox.classList.add('show');}
    function hideErr(){errBox.classList.remove('show');}
    const relTime = (ts)=>{
      if(!ts) return "";
      const s = Math.floor((Date.now()-ts)/1000);
      if (s < 60) return `${s}ì´ˆ ì „`;
      const m = Math.floor(s/60); if (m < 60) return `${m}ë¶„ ì „`;
      const h = Math.floor(m/60); if (h < 24) return `${h}ì‹œê°„ ì „`;
      const d = Math.floor(h/24); return `${d}ì¼ ì „`;
    };

    window.addEventListener('error', e=> showErr('ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬: '+(e.message||'unknown')));

    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, addDoc, onSnapshot, doc, runTransaction, query, orderBy, setDoc, deleteDoc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

      const firebaseConfig = {
        apiKey: "AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4",
        authDomain: "bs-owner-monitor.firebaseapp.com",
        projectId: "bs-owner-monitor"
      };
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      const auth = getAuth(app);
      await setPersistence(auth, browserLocalPersistence);
      const provider = new GoogleAuthProvider();

      // UI refs
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn= document.getElementById('logoutBtn');
      const whoami   = document.getElementById('whoami');
      const panel    = document.getElementById('panel');
      const conn     = document.getElementById('conn');
      const selftest = document.getElementById('selftest');

      // Auth
      loginBtn.onclick = async () => { try { await signInWithPopup(auth, provider); } catch(e){ showErr(e.message); } };
      logoutBtn.onclick= async () => { await signOut(auth); };

      onAuthStateChanged(auth, (user) => {
        if (user) {
          whoami.textContent = user.email;
          panel.style.display = "";     // ë¡œê·¸ì¸ë˜ë©´ íŒ¨ë„ í‘œì‹œ
          logoutBtn.style.display = "";
        } else {
          whoami.textContent = "";
          panel.style.display = "none";
          logoutBtn.style.display = "none";
        }
      });

      // ì‹ ê·œ í™˜ì ì¶”ê°€
      const patientName = document.getElementById('patientName');
      const guardianName= document.getElementById('guardianName');
      const addCaseBtn  = document.getElementById('addCase');
      addCaseBtn.onclick = async ()=>{
        const pn = patientName.value.trim();
        const gn = guardianName.value.trim();
        if (!pn && !gn) return showErr("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        try {
          await addDoc(collection(db,"cases"),{
            patientName: pn, guardianName: gn,
            location:"ì›ë‚´ëŒ€ê¸°ì¤‘",
            createdAt: Date.now(), updatedAt: Date.now(),
            version:1, callRequested:false
          });
          patientName.value = ""; guardianName.value = ""; hideErr();
        } catch(e){ showErr("í™˜ì ì¶”ê°€ ì‹¤íŒ¨: "+e.message); }
      };

      // ê³µìš© ìƒíƒœ ë²„íŠ¼ êµ¬ì„± (ë””ìŠ¤í”Œë ˆì´ ê¸°ì¤€ìœ¼ë¡œ í†µì¼)
      const globalStatesWrap = document.getElementById('globalStates');
      const STATES = ["ìƒë‹´ëŒ€ê¸°ì¤‘","ì›ë‚´ëŒ€ê¸°ì¤‘","ì¹´í˜ëŒ€ê¸°ì¤‘","ì™¸ì¶œì¤‘","ì¹´í˜ì½œì™„ë£Œ","ì™¸ì¶œì½œì™„ë£Œ","ê·€ê°€","ìˆ˜ë‚©í›„ë¯¸ê·€ê°€"];
      STATES.forEach(s=>{
        const b = document.createElement('button');
        b.textContent = s;
        b.onclick = ()=> applyGlobalState(s);
        globalStatesWrap.appendChild(b);
      });

      // ê´€ë¦¬ ë²„íŠ¼
      const renameBtn = document.getElementById('renameBtn');
      const deleteBtn = document.getElementById('deleteBtn');

      let selectedId = null; // ì„ íƒëœ í™˜ì
      const caseList = document.getElementById('caseList');

      function prettyName(d, id){
        return (d.patientName||d.guardianName)
          ? (d.patientName && d.guardianName ? `${d.patientName}(${d.guardianName})` : (d.patientName||d.guardianName))
          : id;
      }

      function renderLine(id, d){
        const line = document.createElement('div'); line.className = 'line'; line.dataset.id = id;

        const name = document.createElement('div'); name.className='name'; name.textContent = prettyName(d,id);
        const state= document.createElement('div'); state.className='state'; state.textContent = d.location || '';
        const upd  = document.createElement('div'); upd.className='updated'; upd.textContent = d.updatedAt ? relTime(d.updatedAt) : '';

        line.appendChild(name); line.appendChild(state); line.appendChild(upd);

        line.onclick = ()=>{
          selectedId = id;
          // ì„ íƒ í‘œì‹œ
          [...caseList.children].forEach(el=> el.classList.remove('select'));
          line.classList.add('select');
        };

        // ì½œìš”ì²­ ê°•ì¡°
        if (d.callRequested) line.classList.add('calling');
        return line;
      }

      async function updateCase(id, data){
        try {
          await runTransaction(db, async (tx)=>{
            const ref = doc(db,"cases", id);
            const snap = await tx.get(ref);
            const prev = snap.exists()? snap.data(): {version:0};
            tx.set(ref, { ...data, updatedAt: Date.now(), version:(prev.version||0)+1 }, { merge:true });
          });
          hideErr();
        } catch(e){ showErr("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
      }

      async function applyGlobalState(state){
        if (!selectedId) { showErr("ë¨¼ì € í™˜ì í•œ ëª…ì„ ë¦¬ìŠ¤íŠ¸ì—ì„œ í´ë¦­í•´ ì„ íƒí•˜ì„¸ìš”."); return; }
        if (state === "ê·€ê°€") {
          const yes = confirm("ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œí• ê¹Œìš”? (ì˜ˆ: ë¬¸ì„œë¥¼ ì‚­ì œ / ì•„ë‹ˆì˜¤: ìƒíƒœë§Œ 'ê·€ê°€'ë¡œ í‘œì‹œ)");
          if (yes) {
            try { await deleteDoc(doc(db,"cases", selectedId)); hideErr(); selectedId = null; }
            catch(e){ showErr("ì‚­ì œ ì‹¤íŒ¨: "+e.message); }
            return;
          }
        }
        await updateCase(selectedId, { location: state, callRequested:false });
      }

      // ì´ë¦„ ë³€ê²½
      renameBtn.onclick = async ()=>{
        if (!selectedId) return showErr("ë¨¼ì € í™˜ì í•œ ëª…ì„ ì„ íƒí•˜ì„¸ìš”.");
        try{
          const ref = doc(db,"cases", selectedId);
          const snap = await getDoc(ref);
          if (!snap.exists()){ return showErr("ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
          const cur = snap.data();
          const newPatient  = prompt("ê³ ì–‘ì´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ê³µë°± ì…ë ¥ ì‹œ ë³€ê²½ ì•ˆ í•¨):", cur.patientName || "");
          if (newPatient === null) return; // ì·¨ì†Œ
          const newGuardian = prompt("ë³´í˜¸ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ê³µë°± ì…ë ¥ ì‹œ ë³€ê²½ ì•ˆ í•¨):", cur.guardianName || "");
          if (newGuardian === null) return;
          const data = {};
          if (newPatient !== "" ) data.patientName  = newPatient.trim();
          if (newGuardian !== "") data.guardianName = newGuardian.trim();
          if (Object.keys(data).length===0) { hideErr(); return; }
          await updateCase(selectedId, data);
        }catch(e){ showErr("ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: "+e.message); }
      };

      // ì‚­ì œ ë²„íŠ¼ (ëª…ì‹œì  ì‚­ì œ)
      deleteBtn.onclick = async ()=>{
        if (!selectedId) return showErr("ë¨¼ì € í™˜ì í•œ ëª…ì„ ì„ íƒí•˜ì„¸ìš”.");
        const ok = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)");
        if (!ok) return;
        try {
          await deleteDoc(doc(db,"cases", selectedId));
          selectedId = null;
          hideErr();
        }catch(e){ showErr("ì‚­ì œ ì‹¤íŒ¨: "+e.message); }
      };

      // ì‹¤ì‹œê°„ ë¦¬ìŠ¤íŠ¸ & ì½œìš”ì²­ ì•Œë¦¼ + ê°•ì¡°
      const alertBox = document.getElementById('alertBox');
      const alertWho = document.getElementById('alertWho');
      const bell     = document.getElementById('bell');
      const ackBtn   = document.getElementById('ack');

      onSnapshot(query(collection(db,"cases"), orderBy("createdAt","desc")), (snap)=>{
        hideErr();
        // ë¦¬ìŠ¤íŠ¸ ë Œë”
        caseList.innerHTML = "";
        let firstId = null;
        let anyReq = null;

        snap.forEach(docu=>{
          const d = docu.data();
          const el = renderLine(docu.id, d);
          caseList.appendChild(el);
          if (!firstId) firstId = docu.id;
          if (d.callRequested) anyReq = { id: docu.id, d };
        });

        // ìµœì´ˆ ì„ íƒ ìë™
        if (!selectedId && firstId) {
          selectedId = firstId;
          const firstEl = caseList.querySelector('[data-id="'+firstId+'"]');
          if (firstEl) firstEl.classList.add('select');
        }

        // ì½œìš”ì²­ íŒì—…
        if (anyReq) {
          const d = anyReq.d;
          alertWho.textContent = prettyName(d, anyReq.id);
          alertBox.classList.add('show');
          try { bell.currentTime = 0; bell.play().catch(()=>{}); } catch(e){}
          ackBtn.onclick = ()=> updateCase(anyReq.id, { callRequested:false, location:"ì¹´í˜ì½œì™„ë£Œ" });
        } else {
          alertBox.classList.remove('show');
        }

        conn.textContent="ì—°ê²°ë¨"; conn.className="pill ok";
      }, (e)=>{ conn.textContent="ì—°ê²° ì˜¤ë¥˜"; conn.className="pill err"; showErr("ë¦¬ìŠ¤íŠ¸ êµ¬ë… ì‹¤íŒ¨: "+e.message); });

      // ì—°ê²° í…ŒìŠ¤íŠ¸
      selftest.onclick = async ()=>{
        try {
          await setDoc(doc(db,"healthcheck","reception"), { ping: Date.now() }, { merge:true });
          conn.textContent="ì—°ê²° ì •ìƒ"; conn.className="pill ok"; hideErr();
        } catch(e){ conn.textContent="ì—°ê²° ì˜¤ë¥˜"; conn.className="pill err"; showErr("ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: "+e.message); }
      };

    } catch(e) {
      showErr("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: "+(e.message||e));
      const conn = document.getElementById('conn'); conn.textContent="ì´ˆê¸°í™” ì˜¤ë¥˜"; conn.className="pill err";
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BS Owner Monitor (Reception)</title>
  <style>
    :root{
      --bg:#fafafa; --card:#ffffff; --border:#e5e7eb;
      --fg:#0f172a; --muted:#64748b;
      --brand:#2b5fa3;                /* ë¡œê³  ë¸”ë£¨ */
      --brand-ink:#102339;            /* ë¸Œëœë“œ ëŒ€ë¹„ í…ìŠ¤íŠ¸ */
      --btn:#f1f5f9;                  /* ê¸°ë³¸ ë²„íŠ¼ ë°°ê²½ */
      --btn-ink:#111827;              /* ê¸°ë³¸ ë²„íŠ¼ ê¸€ì */
      --btn-hover:#e2e8f0;            /* ê¸°ë³¸ ë²„íŠ¼ í˜¸ë²„ */
      --pill:#1f2937;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}

    /* ìƒë‹¨ ìš°ì¸¡: ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; justify-content:flex-end; align-items:center;
      gap:6px; padding:6px 10px; background:rgba(250,250,250,.85); backdrop-filter:saturate(180%) blur(6px);
      border-bottom:1px solid var(--border);
      font-size:12px;
    }
    .topbar button{border:0;border-radius:8px;padding:6px 8px;background:var(--btn);color:var(--btn-ink);cursor:pointer}
    .topbar button:hover{background:var(--btn-hover)}
    .topbar .ok{background:var(--brand);color:#fff}
    .topbar .ok:hover{filter:brightness(.95)}
    .whoami{opacity:.7}

    main{padding:16px}
    h1{margin:6px 0 12px; display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo{width:28px;height:28px;border-radius:6px;object-fit:cover}

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:12px; padding:12px; margin-bottom:12px;
    }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 4px 2px}

    /* ì…ë ¥ ì¤„: ìŠ¤í¬ë¡¤ ì—†ì´ í•œ ì¤„ ê³ ì •, ìµœì†Œí­ ì¶•ì†Œ */
    .inputs-wrap{
      display:flex; gap:8px; align-items:flex-end; flex-wrap:nowrap;
    }
    .inputs-wrap input{
      flex:1 1 80px; min-width:80px;      /* ìš”ì²­: ê°ê° ìµœì†Œë„ˆë¹„ (80px) */
      padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; font-size:15px; background:#fff;
    }

    /* ë²„íŠ¼ */
    .btn{cursor:pointer;border:1px solid #d1d5db;border-radius:10px;padding:12px 14px;font-weight:700;background:var(--btn);color:var(--btn-ink);white-space:nowrap;transition:.15s}
    .btn:hover{background:var(--btn-hover)}
    .btn.ok{border-color:transparent;background:var(--brand);color:#fff}
    .btn.ok:hover{filter:brightness(.95)}
    .btn.dark{border-color:#111827;background:#111827;color:#fff}

    .small{font-size:12px;opacity:.75;margin-top:24px}  /* ê°„ê²© 3ë°°ë¡œ í™•ëŒ€ */

    /* ìƒíƒœ ë²„íŠ¼ ë‘ ì¤„ ê³ ì • */
    .toolbar{display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto}
    .toolbar + .toolbar{margin-top:8px}
    .toolbar button{white-space:nowrap}

    /* ë©”ëª¨ ì˜ì—­ */
    .memo-wrap{display:flex; gap:8px; align-items:center; margin-top:16px}
    .memo-wrap input{
      flex:1 1 auto; min-width:120px;
      padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font-size:14px;
    }

    /* ë¦¬ìŠ¤íŠ¸ */
    .list{display:grid;grid-template-columns:1fr;gap:6px;margin-top:8px}
    .line{display:grid;grid-template-columns:1.4fr .8fr .6fr;gap:8px;align-items:center;
          background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .name{font-weight:800;text-align:left}
    .state{font-weight:900;text-align:center}
    .updated{font-size:12px;opacity:.7;text-align:right}
    .line.select{outline:3px solid var(--brand); outline-offset:0}        /* ì„ íƒ í…Œë‘ë¦¬ = ë¸Œëœë“œ ë¸”ë£¨ */
    .line.calling{outline:3px solid rgba(220,38,38,.6); animation:callblink 1.1s linear infinite}
    @keyframes callblink{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.8)}}

    /* í•˜ë‹¨ ìƒíƒœë°” */
    .statusbar{position:fixed;bottom:8px;left:8px;right:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:var(--pill);color:#fff}
    .pill.ok{background:#16a34a}.pill.err{background:#dc2626}.pill.warn{background:#f59e0b}

    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700}
    .errbox.show{display:block}

    .alert{display:none;margin:10px 0;padding:14px 16px;border-radius:12px;border:2px solid #ef4444;background:#fef2f2;color:#991b1b;font-weight:900}
    .alert.show{display:block;animation:pop .5s}
    @keyframes pop{from{transform:scale(.98)}to{transform:scale(1)}}
  </style>
</head>
<body>
  <!-- ìƒë‹¨ ìš°ì¸¡ ë¡œê·¸ì¸ ì˜ì—­ -->
  <div class="topbar" id="authBox">
    <span id="whoami" class="whoami"></span>
    <button id="loginBtn" class="ok">Googleë¡œ ë¡œê·¸ì¸</button>
    <button id="logoutBtn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <main>
    <h1>
      <img class="logo" src="image-512.png" alt="BS Logo" />
      BS Owner Monitor (Reception)
    </h1>

    <div id="err" class="errbox"></div>

    <!-- ì½œìš”ì²­ ì•Œë¦¼ -->
    <div id="alertBox" class="alert">ğŸ“£ ì²˜ì¹˜ì‹¤ì—ì„œ <span id="alertWho"></span> ì½œ ìš”ì²­!
      <button id="ack" class="btn ok" style="margin-left:8px">ì²˜ë¦¬ì™„ë£Œ</button>
    </div>

    <div id="panel" style="display:none">
      <!-- í™˜ì ì…ë ¥ + ì¶”ê°€ (í•œ ì¤„ ê³ ì •) -->
      <div class="card">
        <div class="inputs-wrap">
          <div>
            <label>ê³ ì–‘ì´ ì´ë¦„</label>
            <input id="patientName" type="text" placeholder="ì˜ˆ: ê³µì‹¬ì´" />
          </div>
          <div>
            <label>ë³´í˜¸ì ì´ë¦„</label>
            <input id="guardianName" type="text" placeholder="ì˜ˆ: ê¹€OO" />
          </div>
          <button id="addCase" class="btn ok">í™˜ì ì¶”ê°€</button>
        </div>

        <!-- ìƒíƒœ ë²„íŠ¼: ë‘ ì¤„ ê³ ì • -->
        <div class="small">ì„ íƒ í™˜ìì— ì ìš©ë©ë‹ˆë‹¤.</div>
        <div class="toolbar" id="row1"></div>
        <div class="toolbar" id="row2"></div>

        <!-- ì„ íƒ í™˜ì ë©”ëª¨ -->
        <div class="memo-wrap">
          <input id="memoInput" type="text" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" />
          <button id="memoSaveBtn" class="btn">ë©”ëª¨ ì €ì¥</button>
        </div>
      </div>

      <!-- í™˜ì ë¦¬ìŠ¤íŠ¸ -->
      <div class="card">
        <div class="list">
          <div class="line" style="background:#f8fafc">
            <div class="name">ì´ë¦„</div>
            <div class="state">ìƒíƒœ</div>
            <div class="updated">ì—…ë°ì´íŠ¸</div>
          </div>
          <div id="caseList" class="list"></div>
        </div>
      </div>
    </div>

    <div class="statusbar">
      <span id="conn" class="pill warn">ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
      <button id="selftest" class="pill">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    </div>

    <audio id="bell" preload="auto">
      <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>
  </main>

  <script type="module">
    const errBox = document.getElementById('err');
    function showErr(msg){errBox.textContent=msg; errBox.classList.add('show');}
    function hideErr(){errBox.classList.remove('show');}
    const relTime = (ts)=>{
      if(!ts) return "";
      const s = Math.floor((Date.now()-ts)/1000);
      if (s < 60) return `${s}ì´ˆ ì „`;
      const m = Math.floor(s/60); if (m < 60) return `${m}ë¶„ ì „`;
      const h = Math.floor(m/60); if (h < 24) return `${h}ì‹œê°„ ì „`;
      const d = Math.floor(h/24); return `${d}ì¼ ì „`;
    };

    window.addEventListener('error', e=> showErr('ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬: '+(e.message||'unknown')));

    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, addDoc, onSnapshot, doc, runTransaction, query, orderBy, setDoc, deleteDoc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

      const firebaseConfig = {
        apiKey: "AIzaSyDxhY_FjNOp_F0g-DXypaoN7RRjFqNIoG4",
        authDomain: "bs-owner-monitor.firebaseapp.com",
        projectId: "bs-owner-monitor"
      };
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      const auth = getAuth(app);
      await setPersistence(auth, browserLocalPersistence);
      const provider = new GoogleAuthProvider();

      // ìƒë‹¨ ë¡œê·¸ì¸ ë²„íŠ¼ ë™ì‘ (ë‹¹ì‹ ì´ ì¤€ 'ë™ì‘ í™•ì¸ëœ' ë°©ì‹ ê·¸ëŒ€ë¡œ ìœ ì§€)
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn= document.getElementById('logoutBtn');
      const whoami   = document.getElementById('whoami');
      const panel    = document.getElementById('panel');
      const conn     = document.getElementById('conn');
      const selftest = document.getElementById('selftest');

      loginBtn.onclick = async () => { try { await signInWithPopup(auth, provider); } catch(e){ showErr(e.message); } };
      logoutBtn.onclick= async () => { await signOut(auth); };

      onAuthStateChanged(auth, (user) => {
        if (user) {
          whoami.textContent = user.email;
          panel.style.display = "";
          logoutBtn.style.display = "";
          loginBtn.style.display = "none";
        } else {
          whoami.textContent = "";
          panel.style.display = "none";
          logoutBtn.style.display = "none";
          loginBtn.style.display = "";
        }
      });

      // ì‹ ê·œ í™˜ì ì¶”ê°€
      const patientName = document.getElementById('patientName');
      const guardianName= document.getElementById('guardianName');
      const addCaseBtn  = document.getElementById('addCase');
      addCaseBtn.onclick = async ()=>{
        const pn = patientName.value.trim();
        const gn = guardianName.value.trim();
        if (!pn && !gn) return showErr("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        try {
          await addDoc(collection(db,"cases"),{
            patientName: pn, guardianName: gn,
            location:"ì›ë‚´ëŒ€ê¸°ì¤‘",
            createdAt: Date.now(), updatedAt: Date.now(),
            version:1, callRequested:false,
            memo:""                              /* ë©”ëª¨ í•„ë“œ ì¶”ê°€ */
          });
          patientName.value = ""; guardianName.value = ""; hideErr();
        } catch(e){ showErr("í™˜ì ì¶”ê°€ ì‹¤íŒ¨: "+e.message); }
      }


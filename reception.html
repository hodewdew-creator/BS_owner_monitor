<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BS 대기실 모니터 (리셉용)</title>
  <style>
    :root{
      --bg:#fafafa; --card:#ffffff; --border:#e5e7eb;
      --fg:#0f172a; --muted:#64748b;
      --brand:#2b5fa3; --brand-ink:#102339;
      --btn:#f1f5f9; --btn-ink:#111827; --btn-hover:#e2e8f0;
      --pill:#1f2937;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    .top{
      position:sticky; top:0; z-index:20; background:#fafafacc; backdrop-filter:blur(8px);
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 8px; border-bottom:1px solid var(--border);
    }
    .title{display:flex; align-items:center; gap:8px}
    .pill{
      background:#111827; color:#e5e7eb; border:1px solid #1f2937; padding:4px 10px; border-radius:999px; font-weight:800; font-size:13px;
    }
    .grid{
      display:grid; gap:14px; grid-template-columns: 1.3fr 1fr;
    }
    @media (max-width:980px){ .grid{grid-template-columns: 1fr;} }

    .panel{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px}
    .panel h3{margin:0 0 8px; font-size:16px}
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;
    }
    .btn{
      background:var(--btn); color:var(--btn-ink); border:1px solid #cbd5e1;
      padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer;
    }
    .btn:hover{background:var(--btn-hover)}
    .btn.dark{background:#0f172a;color:#e5e7eb;border-color:#0b1220}

    .list{display:flex; flex-direction:column; gap:10px; max-height:70vh; overflow:auto}
    .line{
      display:grid; grid-template-columns: 1fr .8fr .9fr 1fr auto; gap:10px;
      align-items:center; padding:10px; border:1px solid var(--border); border-radius:12px;
    }
    .name{font-weight:900}
    .muted{color:var(--muted)}
    .sep{opacity:.5}
    .f12{font-size:12px}

    /* 입력창 그리드 */
    .inputs-wrap{
      display:grid; gap:10px;
      grid-template-columns: 1fr 1fr 1fr auto;
      align-items:center;
    }
    @media (max-width:900px){
      .inputs-wrap{ grid-template-columns: 1fr 1fr; }
    }

    /* input은 "자기 칼럼을 꽉 채우기"만! (고정폭은 그리드가 담당) */
    .inputs-wrap input{
      width:100%;
      min-width:0;
      padding:8px 10px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      font-size:15px;
      background:#fff;
      box-sizing:border-box;
    }

    .err{
      display:none; position:fixed; inset:auto 12px 12px 12px; z-index:50;
      padding:10px 12px; border-radius:12px; background:#f87171; color:#111; font-weight:800; border:1px solid #7f1d1d;
    }

    /* 기존 작은 배너 알림 */
    .alert{display:none;margin:10px 0;padding:14px 16px;border-radius:12px;border:2px solid #ef4444;background:#fef2f2;color:#991b1b;font-weight:900}
    .alert.show{display:block;animation:pop .5s}
    @keyframes pop{from{transform:scale(.98)}to{transform:scale(1)}}

    /* === 큰 팝업 오버레이 === */
    .overlay{
      position:fixed; inset:0; z-index:80; display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.65); backdrop-filter:blur(4px);
    }
    .overlay.show{display:flex}
    .modal{
      width:min(720px,92vw);
      background:#ffffff; color:#0f172a; border-radius:16px; border:3px solid #ef4444;
      padding:18px 18px 16px; box-shadow:0 15px 40px rgba(2,6,23,.35);
      display:flex; flex-direction:column; gap:12px;
    }
    .modal h4{margin:0; font-size:18px}
    .modal .row{display:flex; gap:8px; align-items:center; justify-content:flex-end}
    .modal .ok{
      background:#ef4444; color:#fff; border:none; border-radius:12px; font-weight:900; padding:12px 16px; cursor:pointer;
    }
    .modal .ok:hover{opacity:.9}

  </style>
</head>
<body>
  <div class="top">
    <div class="title">
      <span class="pill">BS 리셉션</span>
      <span class="muted f12">상태 지정 & 환자 관리</span>
    </div>
    <div class="right muted f12">내부 전용</div>
  </div>

  <div class="wrap">
    <div id="err" class="err"></div>

    <div class="grid">
      <!-- 왼쪽: 상태 변경 -->
      <div class="panel">
        <h3>상태 설정</h3>

        <div class="toolbar" id="row1"></div>
        <div class="toolbar" id="row2"></div>
        <div class="toolbar" id="row3"></div>

        <div class="inputs-wrap" style="margin-top:12px">
          <input id="patientName" placeholder="환자명"/>
          <input id="guardianName" placeholder="보호자명"/>
          <input id="memo" placeholder="메모 (선택)"/>
          <button id="addBtn" class="btn">추가</button>
        </div>

        <!-- 작은 경고 배너 -->
        <div id="smallAlert" class="alert">먼저 오른쪽 목록에서 환자를 선택하세요.</div>

        <!-- 큰 팝업 -->
        <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="selTitle">
          <div class="modal">
            <h4 id="selTitle">환자 미선택</h4>
            <div>상태를 변경하려면 <b>오른쪽 “환자 목록”</b>에서 대상을 먼저 선택해주세요.</div>
            <div class="row"><button id="okBtn" class="ok">확인</button></div>
          </div>
        </div>
      </div>

      <!-- 오른쪽: 목록 -->
      <div class="panel">
        <h3>환자 목록</h3>
        <div id="list" class="list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    const errBox=document.getElementById('err');
    const showErr=(msg)=>{ errBox.textContent=msg; errBox.style.display='block'; }
    const hideErr=()=>{ errBox.style.display='none'; }

    /* 가벼운 UX: 작은 배너 & 큰 팝업 */
    const smallAlert=document.getElementById('smallAlert');
    const overlay=document.getElementById('overlay');
    const okBtn=document.getElementById('okBtn');
    okBtn.onclick=()=> overlay.classList.remove('show');
    function requireSelection(){
      // 작은 배너 즉시 표출 + 큰 팝업(중복호출 방지)
      smallAlert.classList.add('show');
      overlay.classList.add('show');
      setTimeout(()=> smallAlert.classList.remove('show'), 1600);
    }

    let auth, provider, db;
    let selectedId=null;

    const patientName=document.getElementById('patientName');
    const guardianName=document.getElementById('guardianName');
    const memoInput=document.getElementById('memo');
    const addBtn=document.getElementById('addBtn');

    const elList=document.getElementById('list');

    try{
      const { initializeApp }=await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js");
      const { getAuth, GoogleAuthProvider, signInWithPopup }=await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js");
      const { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc }=await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js");

      const app = initializeApp({
        apiKey: "AIzaSyDUMMYxxxx",
        authDomain: "bs-owner-monitor.firebaseapp.com",
        projectId: "bs-owner-monitor",
      });
      auth=getAuth(app); provider=new GoogleAuthProvider(); db=getFirestore(app);
      await signInWithPopup(auth, provider);

      // 추가
      addBtn.onclick=async()=>{
        const pn=(patientName.value||"").trim();
        const gn=(guardianName.value||"").trim();
        if(!pn || !gn){ showErr("환자명/보호자명을 입력하세요."); return; }
        try{
          await addDoc(collection(db,"cases"),{
            petName:pn, guardianName:gn, createdAt:Date.now(),
            location:"상담대기중", callRequested:false, memo:(memoInput.value||"").trim()
          });
          patientName.value = ""; guardianName.value = ""; memoInput.value=""; hideErr();
        } catch(e){ showErr("환자 추가 실패: "+e.message); }
      };

      // 상태 버튼: 기존 2줄 + (신규) 세 번째 줄(진료실)
      const row1 = document.getElementById('row1');
      const row2 = document.getElementById('row2');
      const row3 = document.getElementById('row3');
      const ROW1 = ["상담대기중","원내대기중","카페대기중","외출중"];
      const ROW2 = ["카페콜완료","외출콜완료","귀가","수납후미귀가"]; // + 삭제(별도)
      const ROW3 = ["1 진료실","2 진료실","3 진료실","4 진료실"];

      function makeBtn(text, onClick, cls="btn"){
        const b = document.createElement('button');
        b.className = cls; b.textContent = text; b.onclick = onClick;
        return b;
      }
      ROW1.forEach(s=> row1.appendChild(makeBtn(s, ()=>applyGlobalState(s))));
      ROW2.forEach(s=> row2.appendChild(makeBtn(s, ()=>applyGlobalState(s))));
      ROW3.forEach(s=> row3.appendChild(makeBtn(s, ()=>applyGlobalState(s))));

      const delBtn = makeBtn("삭제", onDelete, "btn dark");
      row2.appendChild(delBtn);

      // 실시간 목록
      onSnapshot(query(collection(db,"cases"),orderBy("createdAt","desc")),(snap)=>{
        hideErr();
        const docs=snap.docs.map(d=>({id:d.id,...d.data()}));
        renderList(docs);
      }, (e)=> showErr("실시간 구독 오류: "+e.message));

      async function applyGlobalState(state){
        if(!selectedId){ requireSelection(); return; }
        try{
          await updateDoc(doc(db,"cases",selectedId),{
            location: state,
            callRequested:false   // 버튼 클릭 시 콜요청 자동 해제
          });
          hideErr();
        }catch(e){ showErr("상태 변경 실패: "+e.message); }
      }

      async function onDelete(){
        if(!selectedId){ requireSelection(); return; }
        if(!confirm("정말 삭제할까요?")) return;
        try{
          await deleteDoc(doc(db,"cases",selectedId));
          selectedId=null; hideErr();
        }catch(e){ showErr("삭제 실패: "+e.message); }
      }

      function fmtName(d){
        return d.petName ? `${d.petName} <span class="sep">·</span> ${d.guardianName}` : d.guardianName || "(이름 없음)";
      }
      function shortId(id){
        return id?.length>6 ? (id.slice(0,3)+"…"+id.slice(-3)) : id;
      }

      // 상태 텍스트 컬러 매핑 (진료실은 백산 블루)
      function colorForState(s){
        if (s==="상담대기중") return "#dc2626";
        if (s==="원내대기중" || s==="카페대기중") return "#d97706";
        if (s==="외출중") return "#0284c7";
        if (s==="카페콜완료" || s==="외출콜완료") return "#16a34a";
        if (s==="1 진료실" || s==="2 진료실" || s==="3 진료실" || s==="4 진료실") return "#2b5fa3";
        if (s==="귀가" || s==="수납후미귀가") return "#64748b";
        return "";
      }

      function renderLine(id, d){
        const line = document.createElement('div'); line.className='line';
        line.onclick=()=>{ selectedId=id; Array.from(document.querySelectorAll('.line')).forEach(x=>x.style.outline=''); line.style.outline='2px solid #93c5fd'; }

        const name=document.createElement('div'); name.className='name'; name.innerHTML=fmtName(d);
        const state=document.createElement('div'); state.innerHTML=`<b style="color:${colorForState(d.location||'')}">${d.location||'-'}</b>`;
        const memo=document.createElement('div'); memo.className='muted'; memo.textContent=(d.memo||'');
        const created=document.createElement('div'); created.className='muted'; created.textContent=(new Date(d.createdAt||0)).toLocaleString();
        const idbox=document.createElement('div'); idbox.className='muted f12'; idbox.textContent=shortId(id);

        line.appendChild(name);
        line.appendChild(state);
        line.appendChild(memo);
        line.appendChild(created);
        line.appendChild(idbox);
        return line;
      }

      function renderList(docs){
        elList.innerHTML='';
        const frag=document.createDocumentFragment();
        docs.forEach(({id, ...d})=> frag.appendChild(renderLine(id,d)));
        elList.appendChild(frag);
      }

    }catch(e){
      showErr("초기화 오류: "+e.message);
    }
  </script>
</body>
</html>


